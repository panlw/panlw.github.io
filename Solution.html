<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
    
  Solution - Junkman
  
  </title>
  
  
  <link href="atom.xml" rel="alternate" title="Junkman" type="application/atom+xml">
    <link rel="stylesheet" href="asset/css/foundation.min.css" />
    <link rel="stylesheet" href="asset/css/docs.css" />
    <script src="asset/js/vendor/modernizr.js"></script>
    <script src="asset/js/vendor/jquery.js"></script>
  <script src="asset/highlightjs/highlight.pack.js"></script>
  <link href="asset/highlightjs/styles/github.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script>hljs.initHighlightingOnLoad();</script>
<script type="text/javascript">
  function before_search(){
    var searchVal = 'site:panlw.github.io ' + document.getElementById('search_input').value;
    document.getElementById('search_q').value = searchVal;
    return true;
  }
</script>
  </head>
  <body class="antialiased hide-extras">
    
    <div class="marketing off-canvas-wrap" data-offcanvas>
      <div class="inner-wrap">


<nav class="top-bar docs-bar hide-for-small" data-topbar>


  <section class="top-bar-section">
  <div class="row">
      <div style="position: relative;width:100%;"><div style="position: absolute; width:100%;">
        <ul id="main-menu" class="left">
        
        <li id=""><a target="self" href="index.html">Home</a></li>
        
        <li id=""><a target="_self" href="archives.html">Archives</a></li>
        
        </ul>

        <ul class="right" id="search-wrap">
          <li>
<form target="_blank" onsubmit="return before_search();" action="http://google.com/search" method="get">
    <input type="hidden" id="search_q" name="q" value="" />
    <input tabindex="1" type="search" id="search_input"  placeholder="Search"/>
</form>
</li>
          </ul>
      </div></div>
  </div>
  </section>

</nav>

        <nav class="tab-bar show-for-small">
  <a href="javascript:void(0)" class="left-off-canvas-toggle menu-icon">
    <span> &nbsp; Junkman</span>
  </a>
</nav>

<aside class="left-off-canvas-menu">
      <ul class="off-canvas-list">
       
       <li><a href="index.html">HOME</a></li>
    <li><a href="archives.html">Archives</a></li>
    <li><a href="about.html">ABOUT</a></li>

    <li><label>Categories</label></li>

        
            <li><a href="Infra.html">Infra</a></li>
        
            <li><a href="Coding.html">Coding</a></li>
        
            <li><a href="Solution.html">Solution</a></li>
        
            <li><a href="Archtect.html">Archtect</a></li>
         

      </ul>
    </aside>

<a class="exit-off-canvas" href="#"></a>


        <section id="main-content" role="main" class="scroll-container">
        
       

 <script type="text/javascript">
	$(function(){
		$('#menu_item_index').addClass('is_active');
	});
</script>
<div class="row">
	<div class="large-8 medium-8 columns">
		<div class="markdown-body home-categories">
		
			<div class="article">
                <a class="clearlink" href="15248824810738.html">
                
                  <h1>理解JWT的使用场景和优劣</h1>
                  <div class="a-content">
                      
                      <div class="a-content-text">
                        
                        	<blockquote>
<p><a href="https://www.cnkirito.moe/2018/04/20/jwt-learn-3/">https://www.cnkirito.moe/2018/04/20/jwt-learn-3/</a></p>
</blockquote>

<p>经过前面两篇文章《<a href="https://www.cnkirito.moe/2018/04/14/jwt-learn/">JSON Web Token - 在Web应用间安全地传递信息</a>》《<a href="https://www.cnkirito.moe/2018/04/14/jwt-learn-2/">八幅漫画理解使用JSON Web Token设计单点登录系统</a>》的科普，相信大家应该已经知道了 JWT 协议是什么了。至少看到</p>

<p>这样形如 A.B.C 的字符串时能敏感地认出这是使用了 jwt。发了这两篇文章后，有不少读者在文末留言，表达了对 jwt 使用方式的一些疑惑，以及到底哪些场景适合使用 jwt。我并不是 jwt 方面的专家，和不少读者一样，起初研究时我也存在相同疑惑，甚至在逐渐接触后产生了更大的疑惑，经过这段时间项目中的使用和一些自己思考，把个人的总结整理成此文。</p>

<h3 id="toc_0"><a href="#%E7%BC%96%E7%A0%81%EF%BC%8C%E7%AD%BE%E5%90%8D%EF%BC%8C%E5%8A%A0%E5%AF%86" title="编码，签名，加密"></a>编码，签名，加密</h3>

<p>这些基础知识简单地介绍下，千万别搞混了三个概念。在 jwt 中恰好同时涉及了这三个概念，笔者用大白话来做下通俗的讲解（非严谨定义，供个人理解）</p>

<h4 id="toc_1"><a href="#%E7%BC%96%E7%A0%81-encode-%E5%92%8C%E8%A7%A3%E7%A0%81-decode" title="编码(encode)和解码(decode)"></a>编码(encode)和解码(decode)</h4>

<p>一般是编码解码是为了方便以字节的方式表示数据，便于存储和网络传输。整个 jwt 串会被置于 http 的 Header 或者 url 中，为了不出现乱码解析错误等意外，编码是有必要的。在 jwt 中以 <code>.</code> 分割的三个部分都经过 base64 编码(secret 部分是否进行 base64 编码是可选的，header 和 payload 则是必须进行 base64 编码)。注意，编码的一个特点：编码和解码的整个过程是可逆的。得知编码方式后，整个 jwt 串便是明文了，随意找个网站验证下解码后的内容：</p>

<p><img src="media/15248824810738/15248826502697.png" alt="base64"/></p>

<p>所以注意一点，<strong>payload 是一定不能够携带敏感数据如密码等信息的</strong>。</p>

<h4 id="toc_2"><a href="#%E7%AD%BE%E5%90%8D-signature" title="签名(signature)"></a>签名(signature)</h4>

<p>签名的目的主要是为了验证我是“我”。jwt 中常用的签名算法是 HS256，可能大多数人对这个签名算法不熟悉，但 md5,sha 这样的签名算法肯定是为人熟知的，签名算法共同的特点是整个过程是不可逆的。由于签名之前的主体内容(header,payload)会携带在 jwt 字符串中，所以需要使用带有密钥(yuè)的签名算法，密钥是服务器和签发者共享的。header 部分和 payload 部分如果被篡改，由于篡改者不知道密钥是什么，也无法生成新的 signature 部分，服务端也就无法通过，在 jwt 中，消息体是透明的，使用签名可以保证消息不被篡改。</p>

<blockquote>
<p>前面转载的文章中，原作者将 HS256 称之为加密算法，不太严谨。</p>
</blockquote>

<h4 id="toc_3"><a href="#%E5%8A%A0%E5%AF%86-encryption" title="加密(encryption)"></a>加密(encryption)</h4>

<p>加密是将明文信息改变为难以读取的密文内容，使之不可读。只有拥有解密方法的对象，经由解密过程，才能将密文还原为正常可读的内容。加密算法通常按照加密方式的不同分为对称加密(如 AES)和非对称加密(如 RSA)。你可能会疑惑：“jwt 中哪儿涉及加密算法了？”，其实 jwt 的 第一部分(header) 中的 alg 参数便可以指定不同的算法来生成第三部分(signature)，大部分支持 jwt 的框架至少都内置 rsa 这种非对称加密方式。这里诞生了第一个疑问</p>

<blockquote>
<p>疑问：一提到 rsa，大多数人第一想到的是非对称加密算法，而 jwt 的第三部分明确的英文定义是 signature，这不是矛盾吗？</p>
</blockquote>

<p>划重点！</p>

<p><strong>rsa 加密</strong>和<strong>rsa 签名</strong> 是两个概念！(吓得我都换行了)</p>

<p>这两个用法很好理解：</p>

<ul>
<li>  既然是加密，自然是不希望别人知道我的消息，只有我自己才能解密，所以<strong>公钥负责加密，私钥负责解密</strong>。这是大多数的使用场景，使用 rsa 来加密。</li>
<li>  既然是签名，自然是希望别人不能冒充我发消息，只有我才能发布签名，所以<strong>私钥负责签名，公钥负责验证</strong>。</li>
</ul>

<p>所以，在客户端使用 rsa 算法生成 jwt 串时，是使用私钥来“加密”的，而公钥是公开的，谁都可以解密，内容也无法变更（篡改者无法得知私钥）。</p>

<p>所以，在 jwt 中并没有纯粹的加密过程，而是使加密之虚，行签名之实。</p>

<h3 id="toc_4"><a href="#%E4%BB%80%E4%B9%88%E5%9C%BA%E6%99%AF%E8%AF%A5%E9%80%82%E5%90%88%E4%BD%BF%E7%94%A8jwt%EF%BC%9F" title="什么场景该适合使用jwt？"></a>什么场景该适合使用jwt？</h3>

<p>来聊聊几个场景，注意，以下的几个场景不是都和jwt贴合。</p>

<ol>
<li> 一次性验证</li>
</ol>

<p>比如用户注册后需要发一封邮件让其激活账户，通常邮件中需要有一个链接，这个链接需要具备以下的特性：能够标识用户，该链接具有时效性（通常只允许几小时之内激活），不能被篡改以激活其他可能的账户…这种场景就和 jwt 的特性非常贴近，jwt 的 payload 中固定的参数：iss 签发者和 exp 过期时间正是为其做准备的。</p>

<ol>
<li> restful api的无状态认证</li>
</ol>

<p>使用 jwt 来做 restful api 的身份认证也是值得推崇的一种使用方案。客户端和服务端共享 secret；过期时间由服务端校验，客户端定时刷新；签名信息不可被修改…spring security oauth jwt 提供了一套完整的 jwt 认证体系，以笔者的经验来看：使用 oauth2 或 jwt 来做 restful api 的认证都没有大问题，oauth2 功能更多，支持的场景更丰富，后者实现简单。</p>

<ol>
<li> 使用 jwt 做单点登录+会话管理(不推荐)</li>
</ol>

<p>在《<a href="https://www.cnkirito.moe/2018/04/14/jwt-learn-2/">八幅漫画理解使用JSON Web Token设计单点登录系统</a>》一文中提及了使用 jwt 来完成单点登录，本文接下来的内容主要就是围绕这一点来进行讨论。如果你正在考虑使用 jwt+cookie 代替 session+cookie ，我强力不推荐你这么做。</p>

<p>首先明确一点：使用 jwt 来设计单点登录系统是一个不太严谨的说法。首先 cookie+jwt 的方案前提是非跨域的单点登录(cookie 无法被自动携带至其他域名)，其次单点登录系统包含了很多技术细节，至少包含了身份认证和会话管理，这还不涉及到权限管理。如果觉得比较抽象，不妨用传统的 session+cookie 单点登录方案来做类比，通常我们可以选择 spring security（身份认证和权限管理的安全框架）和 spring session（session 共享）来构建，而选择用 jwt 设计单点登录系统需要解决很多传统方案中同样存在和本不存在的问题，以下一一详细罗列。</p>

<h3 id="toc_5"><a href="#jwt-token%E6%B3%84%E9%9C%B2%E4%BA%86%E6%80%8E%E4%B9%88%E5%8A%9E%EF%BC%9F" title="jwt token泄露了怎么办？"></a>jwt token泄露了怎么办？</h3>

<p>前面的文章下有不少人留言提到这个问题，我则认为这不是问题。传统的 session+cookie 方案，如果泄露了 sessionId，别人同样可以盗用你的身份。扬汤止沸不如釜底抽薪，不妨来追根溯源一下，什么场景会导致你的 jwt 泄露。</p>

<p>遵循如下的实践可以尽可能保护你的 jwt 不被泄露：使用 https 加密你的应用，返回 jwt 给客户端时设置 httpOnly=true 并且使用 cookie 而不是 LocalStorage 存储 jwt，这样可以防止 XSS 攻击和 CSRF 攻击（对这两种攻击感兴趣的童鞋可以看下 spring security 中对他们的介绍<a href="https://docs.spring.io/spring-security/site/docs/current/reference/html/csrf.html">CSRF</a>,<a href="https://docs.spring.io/spring-security/site/docs/current/reference/html/headers.html#headers-xss-protection">XSS</a>）</p>

<p>你要是正在使用 jwt 访问一个接口，这个时候你的同事跑过来把你的 jwt 抄走了，这种泄露，恕在下无力</p>

<h3 id="toc_6"><a href="#secret%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1" title="secret如何设计"></a>secret如何设计</h3>

<p>jwt 唯一存储在服务端的只有一个 secret，个人认为这个 secret 应该设计成和用户相关的，而不是一个所有用户公用的统一值。这样可以有效的避免一些注销和修改密码时遇到的窘境。</p>

<h3 id="toc_7"><a href="#%E6%B3%A8%E9%94%80%E5%92%8C%E4%BF%AE%E6%94%B9%E5%AF%86%E7%A0%81" title="注销和修改密码"></a>注销和修改密码</h3>

<p>传统的 session+cookie 方案用户点击注销，服务端清空 session 即可，因为状态保存在服务端。但 jwt 的方案就比较难办了，因为 jwt 是无状态的，服务端通过计算来校验有效性。没有存储起来，所以即使客户端删除了 jwt，但是该 jwt 还是在有效期内，只不过处于一个游离状态。分析下痛点：注销变得复杂的原因在于 jwt 的无状态。我提供几个方案，视具体的业务来决定能不能接受。</p>

<ul>
<li>  仅仅清空客户端的 cookie，这样用户访问时就不会携带 jwt，服务端就认为用户需要重新登录。这是一个典型的假注销，对于用户表现出退出的行为，实际上这个时候携带对应的 jwt 依旧可以访问系统。</li>
<li>  清空或修改服务端的用户对应的 secret，这样在用户注销后，jwt 本身不变，但是由于 secret 不存在或改变，则无法完成校验。这也是为什么将 secret 设计成和用户相关的原因。</li>
<li>  借助第三方存储自己管理 jwt 的状态，可以以 jwt 为 key，实现去 redis 一类的缓存中间件中去校验存在性。方案设计并不难，但是引入 redis 之后，就把无状态的 jwt 硬生生变成了有状态了，违背了 jwt 的初衷。实际上这个方案和 session 都差不多了。</li>
</ul>

<p>修改密码则略微有些不同，假设号被到了，修改密码（是用户密码，不是 jwt 的 secret）之后，盗号者在原 jwt 有效期之内依旧可以继续访问系统，所以仅仅清空 cookie 自然是不够的，这时，需要强制性的修改 secret。在我的实践中就是这样做的。</p>

<h3 id="toc_8"><a href="#%E7%BB%AD%E7%AD%BE%E9%97%AE%E9%A2%98" title="续签问题"></a>续签问题</h3>

<p>续签问题可以说是我抵制使用 jwt 来代替传统 session 的最大原因，因为 jwt 的设计中我就没有发现它将续签认为是自身的一个特性。传统的 cookie 续签方案一般都是框架自带的，session 有效期 30 分钟，30 分钟内如果有访问，session 有效期被刷新至 30 分钟。而 jwt 本身的 payload 之中也有一个 exp 过期时间参数，来代表一个 jwt 的时效性，而 jwt 想延期这个 exp 就有点身不由己了，因为 payload 是参与签名的，一旦过期时间被修改，整个 jwt 串就变了，jwt 的特性天然不支持续签！</p>

<p>如果你一定要使用 jwt 做会话管理（payload 中存储会话信息），也不是没有解决方案，但个人认为都不是很令人满意</p>

<ol>
<li> 每次请求刷新 jwt</li>
</ol>

<p>jwt 修改 payload 中的 exp 后整个 jwt 串就会发生改变，那…就让它变好了，每次请求都返回一个新的 jwt 给客户端。太暴力了，不用我赘述这样做是多么的不优雅，以及带来的性能问题。</p>

<p>但，至少这是最简单的解决方案。</p>

<ol>
<li> 只要快要过期的时候刷新 jwt</li>
</ol>

<p>一个上述方案的改造点是，只在最后的几分钟返回给客户端一个新的 jwt。这样做，触发刷新 jwt 基本就要看运气了，如果用户恰巧在最后几分钟访问了服务器，触发了刷新，万事大吉；如果用户连续操作了 27 分钟，只有最后的 3 分钟没有操作，导致未刷新 jwt，无疑会令用户抓狂。</p>

<ol>
<li> 完善 refreshToken</li>
</ol>

<p>借鉴 oauth2 的设计，返回给客户端一个 refreshToken，允许客户端主动刷新 jwt。一般而言，jwt 的过期时间可以设置为数小时，而 refreshToken 的过期时间设置为数天。</p>

<p>我认为该方案并可行性是存在的，但是为了解决 jwt 的续签把整个流程改变了，为什么不考虑下 oauth2 的 password 模式和 client 模式呢？</p>

<ol>
<li> 使用 redis 记录独立的过期时间</li>
</ol>

<p>实际上我的项目中由于历史遗留问题，就是使用 jwt 来做登录和会话管理的，为了解决续签问题，我们在 redis 中单独会每个 jwt 设置了过期时间，每次访问时刷新 jwt 的过期时间，若 jwt 不存在与 redis 中则认为过期。</p>

<blockquote>
<p>tips:精确控制 redis 的过期时间不是件容易的事，可以参考我最近的一篇借助于 spring session 讲解 redis 过期时间的排坑记录。</p>
</blockquote>

<p>同样改变了 jwt 的流程，不过嘛，世间安得两全法。我只能奉劝各位还未使用 jwt 做会话管理的朋友，尽量还是选用传统的 session+cookie 方案，有很多成熟的分布式 session 框架和安全框架供你开箱即用。</p>

<h3 id="toc_9"><a href="#jwt-oauth2-session%E5%8D%83%E4%B8%9D%E4%B8%87%E7%BC%95%E7%9A%84%E8%81%94%E7%B3%BB" title="jwt,oauth2,session千丝万缕的联系"></a>jwt,oauth2,session千丝万缕的联系</h3>

<p>具体的对比不在此文介绍，就一位读者的留言回复下它的提问</p>

<blockquote>
<p>这么长一个字符串，还不如我把数据存到数据库，给一个长的很难碰撞的key来映射，也就是专用token。</p>
</blockquote>

<p>这位兄弟认为 jwt 太长了，是不是可以考虑使用和 oauth2 一样的 uuid 来映射。这里面自然是有问题的，jwt 不仅仅是作为身份的认证（验证签名是否正确，签发者是否存在，有限期是否过期），还在其 payload 中存储着会话信息，这是 jwt 和 session 的最大区别，一个在客户端携带会话信息，一个在服务端存储会话信息。如果真的是要将 jwt 的信息置于在共享存储中，那再找不到任何使用 jwt 的意义了。</p>

<p>jwt 和 oauth2 都可以用于 restful 的认证，就我个人的使用经验来看，spring security oauth2 可以很好的使用多种认证模式：client 模式，password 模式，implicit 模式（authorization code 模式不算单纯的接口认证模式），也可以很方便的实现权限控制，什么样的 api 需要什么样的权限，什么样的资源需要什么样的 scope…而 jwt 我只用它来实现过身份认证，功能较为单一（可能是我没发现更多用法）。</p>

<h3 id="toc_10"><a href="#%E6%80%BB%E7%BB%93" title="总结"></a>总结</h3>

<p>在 web 应用中，使用 jwt 代替 session 存在不小的风险，你至少得解决本文中提及的那些问题，绝大多数情况下，传统的 cookie-session 机制工作得更好。jwt 适合做简单的 restful api 认证，颁发一个固定有效期的 jwt，降低 jwt 暴露的风险，不要对 jwt 做服务端的状态管理，这样才能体现出 jwt 无状态的优势。</p>

<p>可能对 jwt 的使用场景还有一些地方未被我察觉，后续会研究下 spring security oauth jwt 的源码，不知到时会不会有新发现。</p>

                        
                      </div>
                  </div>
                </a>
                <div class="read-more clearfix">
                  <div class="more-left left">
                  
                    <span class="date">2018/4/28</span>
                    <span>posted in&nbsp;</span> 
          				  
          					    <span class="posted-in"><a href='Authc&Authz.html'>Authc&Authz</a></span>
          				   
                  </div>
                  <div class="more-right right">
                  <span class="comments">
                      

                       
                  </span>
                  </div>
                </div>
              </div><!-- article -->
        
			<div class="article">
                <a class="clearlink" href="15244093031262.html">
                
                  <h1>A GraphQL & Node.js Express Tutorial: Powerful E-Commerce with GraphCMS</h1>
                  <div class="a-content">
                      
                      <div class="a-content-text">
                        
                        	<blockquote>
<p><a href="https://snipcart.com/blog/graphql-nodejs-express-tutorial">https://snipcart.com/blog/graphql-nodejs-express-tutorial</a></p>

<p>In a rush? Skip <a href="https://snipcart.com/blog/graphql-nodejs-express-tutorial#tutorial">tutorial steps</a> or <a href="https://snipcart.com/blog/graphql-nodejs-express-tutorial#conclusion">GitHub repo &amp; live demo</a>.</p>
</blockquote>

<p>Trends... they come and go.</p>

<p>Take those fidget spinners for instance, aren&#39;t we all tired of seeing them everywhere, right?</p>

<p>Chances are we&#39;re still stuck with them for a little while, and then we&#39;ll never hear from them again.</p>

<p>Nowhere is the &quot;trend&quot; phenomenon more obvious than in our developer universe, where technologies and shiny new toys appear every day. In this post, I want to try something new that, unlike spinners, is probably here to stay.</p>

<p>I&#39;m talking about <a href="http://graphql.org/"><strong>GraphQL</strong></a>.<br/>
<img src="https://lh3.googleusercontent.com/-7x7a96dgNeo/WuVwY03sBPI/AAAAAAAAACY/xSkMmaV3dG01sNsh4vm7sSXOLaZ8zbQ5wCHMYCw/I/15244094735531.png" alt=""/></p>

<p>Today, we’ll take part in this up-and-coming technology by sharing a GraphQL tutorial, while at the same time trying to capitalize on the last breath of the spinners trend by setting up our own online shop. We&#39;ll integrate GraphQL with <strong>Node.js Express</strong> to create a small e-commerce app.</p>

<p>In fact, we&#39;ll be using the GraphQL-based <a href="https://snipcart.com/blog/intro-api-first-headless-cms-directus">headless content management system</a>, <a href="https://graphcms.com/"><strong>GraphCMS</strong></a> and <a href="http://www.apollodata.com/"><strong>Apollo</strong></a>.</p>

<p>Live demo and full code repo included at the end. ;)</p>

<p><img src="https://lh3.googleusercontent.com/-kILqQsAY-P8/WuVwZEygETI/AAAAAAAAACc/rdEoJRc1zPAa51kDuwMlr2UvluHKj25kQCHMYCw/I/15244095062275.png" alt="GraphCMS logo"/></p>

<p>Let’s <u>spin</u> our way (see what I did there?) into all of the following:</p>

<ol>
<li> Creating a Node.js Express app</li>
<li> Setting up GraphCMS</li>
<li> Querying the GraphQL API using Apollo client</li>
<li> Creating our shop with Snipcart</li>
</ol>

<p>But let’s not get ahead of ourselves and start by digging deeper into what we&#39;re working with here.</p>

<h2 id="toc_0">What is GraphQL?</h2>

<p><strong>GraphQL is a new syntax for your API that defines how to fetch data from one or many databases.</strong></p>

<p>Since this new <u>query language</u> for APIs was open sourced in 2015 by a small company named Facebook (which used it for its mobile apps since 2012), a growing community has been supporting and developing it.</p>

<p>It has been created to solve some structural problems developers encountered when they started to create apps that were way more complex than before.</p>

<p>As for Facebook’s use case, they wanted to put all of the website features into the users&#39; hands, with their mobile apps, back in 2011. That’s when they started to think about a new way of doing things. A way that would make traffic between clients and servers simpler, more organized.</p>

<p>GraphQL was the result.</p>

<p><img src="media/15244093031262/15244098515128.png" alt="What is GraphQL"/></p>

<p>They made it possible to manage data over a single endpoint via HTTP. Each query you send to your API gets you exactly what you want. What I mean here is that you will receive on the other end <u>nothing more</u> and <u>nothing less</u> than what you need. The data needed is determined client side instead of letting servers control it, helping to build apps that are way <u>faster</u> and <u>more stable</u>.</p>

<p>Its <a href="https://dev-blog.apollodata.com/the-anatomy-of-a-graphql-query-6dffa9e9e747">_type schema system_</a> regroups all the data you can access, no matter where it is stored, under different fields. You can relate these to one another in order to get the information needed in one simple request.</p>

<p>Now, this is just a quick GraphQL overview. We won’t get into all the specifics here since it’s not the goal of this post. But there are plenty of helpful resources available should you want to learn more:</p>

<ul>
<li>  <a href="http://graphql.org/learn/best-practices/">Here’s a nice tool</a> to help you get started with it.</li>
<li>  To dive straight into it, take a look at the <a href="https://facebook.github.io/graphql/#">GraphQL specs</a>.</li>
</ul>

<h3 id="toc_1">Why GraphQL over REST APIs?</h3>

<p>This topic has already caused a lot of discussions on dev forums, and what you get out of these is that you can’t compare both <u>directly</u>. <a href="https://philsturgeon.uk/api/2017/01/24/graphql-vs-rest-overview/">They are not the same</a>, and GraphQL won’t take over REST APIs tomorrow morning. Whereas the first is, as I already mentioned, a query language, the other is an <u>architectural concept</u>.</p>

<p>You can actually <a href="https://www.youtube.com/embed/UBGzsb2UkeY">wrap a REST API in GraphQL</a>. This is good to know if you want to try GraphQL without throwing away your existing infrastructure.</p>

<p>Still, more and more developers will turn towards GraphQL for their new APIs, because it solves a lot of the problems that pushed them to scratch their heads with REST’s multiple endpoints.</p>

<p><img src="media/15244093031262/15244097343716.png" alt="REST API vs GraphQL"/></p>

<p>GraphQL vs REST API queries <a href="https://medium.com/@ottovw/rest-api-downfalls-and-dawn-of-graphql-dd00991a0eb8">[source]</a></p>

<p>The latter means you have to make different calls to different endpoints for a single request, like loading a page. It made the process slower as you create more complex architectures. And it can rapidly become a real mess with REST APIs for that reason.</p>

<h3 id="toc_2">So, what should you do?</h3>

<p>It’s entirely up to you, but there are situations where GraphQL starts to look like the best option:</p>

<ul>
<li>  If you have multiple clients, because they simply write their own queries, in the language of their choice, GraphQL supports them all;</li>
<li>  If you work on different platforms: web, mobile, apps, etc;</li>
<li>  If your API is highly customizable.</li>
</ul>

<p>Speaking of <u>highly customizable</u>, we&#39;ll try to determine how we can fit Snipcart into all of this, with the help of an Express app. Before jumping in the demo, let&#39;s learn a bit more about this Node.js Express framework we&#39;ll use.</p>

<h2 id="toc_3">What is Node.js Express?</h2>

<p><strong>Express is a fast, unopinionated, minimalist web framework for Node.js.</strong></p>

<p>We&#39;ve <a href="https://snipcart.com/blog/nodejs-ecommerce-harp-js-static">already played with Node before</a>, but here we&#39;ll use Express for the server-side of our demo. It&#39;s probably the most well-known framework for Node.js right now. <a href="https://expressjs.com/en/starter/installing.html">Official docs over here</a>.</p>

<p>It&#39;s a simple framework that adds fundamental web application features on top of Node.js. It was one of the first out there and is widely used by lots of companies that work with Node.js (IBM, Uber &amp; more).</p>

<p>There&#39;s a ton of modules you can add on top of it to handle most use cases. Like a body parser we&#39;ll use today to deal with JSON payloads.</p>

<p>Although there are some alternatives such as <a href="http://koajs.com/">Koa</a> and <a href="http://sailsjs.com/">SailsJS</a>, I decided to go with the classic and stick to what I know best.</p>

<p>It&#39;s now time to put these awesome tools to use; let&#39;s sell some spinners!</p>

<h2 id="toc_4">Building an e-commerce app: Node.js Express &amp; GraphQL demo</h2>

<p>In this demo, we&#39;ll craft a small shop web application from scratch. Other than Express we&#39;ll be using several technologies to achieve this goal.</p>

<p>Namely, <code>apollo-client</code> from folks at <strong>Apollo</strong>, a very neat framework that makes it easy to query a GraphQL API.</p>

<p>The GraphQL API will be handled by <strong>GraphCMS</strong>.</p>

<p>On top of that, we&#39;ll add our e-commerce solution, Snipcart. ;)</p>

<h3 id="toc_5">Getting started with Node.js Express</h3>

<p>We&#39;ll start by initializing a new node project.</p>

<pre><code>npm init

</code></pre>

<p>Answer the quick questions that the CLI will ask you.</p>

<p>This will create the <code>project.json</code> file and then we&#39;ll be ready to start for real.</p>

<p>We&#39;ll first need to add <code>express</code> npm package.</p>

<pre><code>npm install express --save

</code></pre>

<p>Then, we&#39;ll create the entry file of our application. Let&#39;s name it <code>server.js</code>.</p>

<pre><code>// /server.js

const express = require(&#39;express&#39;)
const app = express()

app.listen(3000, function() {
    console.log(&#39;Listening on port 3000.&#39;);
})

</code></pre>

<p>The first thing we&#39;ll do is to set the view engine we are going to use. In our case, we&#39;ll go ahead with <code>pug</code>.</p>

<pre><code>npm install pug --save

</code></pre>

<p>Then we&#39;ll add these lines to the <code>server.js</code> file.</p>

<pre><code>// /server.js

app.set(&#39;view engine&#39;, &#39;pug&#39;)
app.set(&#39;views&#39;, path.join(__dirname, &#39;/app/views&#39;))

</code></pre>

<p>This will set our default view engine and the path where our views will be located.</p>

<p>We&#39;ll then need to create a router to show the list of our products. Create a new directory named <code>app</code> in your root folder and then create another folder named <code>routers</code> in the former.</p>

<p>We&#39;ll create a router named <code>products.js</code>.</p>

<pre><code>// /app/routers/products.js

const express = require(&#39;express&#39;)
const router = express.Router()

router.get(&#39;/&#39;, (req, res) =&gt; {
})

</code></pre>

<p>We&#39;ll need to register this router in our app. Add these lines to <code>server.js</code> file:</p>

<pre><code>// /server.js

const products = require(&#39;./app/routers/products&#39;)
app.use(&#39;/&#39;, products)

</code></pre>

<h3 id="toc_6">Setting up GraphCMS</h3>

<p>Now for GraphCMS. You&#39;ll need an account: create one <a href="https://app.graphcms.com/">here</a>.</p>

<p>Once logged in, create a new project. I named mine <code>Snipcart demo</code>. Once the project is created, click on Content and then on Add Content Model.</p>

<p><img src="media/15244093031262/15244098950968.png" alt="add-content-model"/></p>

<p>We&#39;ll now define the fields of the product, add the necessary fields so your model looks like this:</p>

<p><img src="media/15244093031262/15244099157106.png" alt="product-fields"/></p>

<p>You can then create a few products. When it&#39;s done we&#39;ll need to get the GraphQL API endpoint and make it readable.</p>

<p>Click on Settings in the menu, and enable Public API Access.</p>

<p><img src="media/15244093031262/15244108383474.png" alt="public-api-access"/></p>

<p>Then note your <strong>Simple Endpoint</strong> URL in the Endpoints section.</p>

<h3 id="toc_7">Querying our GraphQL API</h3>

<p>Back to the code now. We&#39;ll need to change our <code>products.js</code> router to fetch the items from the API. Before that, we&#39;ll create a small service module that&#39;ll interact with the API using Apollo client.</p>

<p>Let&#39;s install the modules we&#39;ll need from npm.</p>

<pre><code>npm install apollo-client graphql-tag node-fetch url numeral --save

</code></pre>

<p>We also install <code>node-fetch</code> because the <code>fetch</code> method used by <code>apollo-client</code> is not yet available in Node.js.</p>

<p><code>url</code> and <code>numeral</code> package will be used for display purposes that we&#39;ll see later.</p>

<p>We&#39;ll also create a configuration file in our project root containing things such as an API endpoint URL and Snipcart API key.</p>

<pre><code>// /config.json

{
    &quot;apiEndpoint&quot;: &quot;https://api.graphcms.com/simple/v1/cj3c0azkizxa6018532qd1tmh&quot;,
    &quot;snipcartApiKey&quot;: &quot;MzMxN2Y0ODMtOWNhMy00YzUzLWFiNTYtZjMwZTRkZDcxYzM4&quot;
}

</code></pre>

<p>Create a new directory named <code>services</code> in the <code>app</code> folder. We&#39;ll add a new file named <code>products.js</code> in it.</p>

<pre><code>// /app/services/products.js

fetch = require(&#39;node-fetch&#39;)
const config = require(&#39;./../../config.json&#39;)
const Apollo = require(&#39;apollo-client&#39;)
const gql = require(&#39;graphql-tag&#39;)
const ApolloClient = Apollo.ApolloClient
const createNetworkInterface = Apollo.createNetworkInterface

const client = new ApolloClient({
    networkInterface: createNetworkInterface({
        uri: config.apiEndpoint
    })
})

module.exports = {
    getAllProducts: () =&gt; {
        return new Promise((resolve, reject) =&gt; {
            client.query({
                query: gql`
                   query {
                        allProducts {
                            name,
                            id,
                            sku,
                            price,
                            description,
                            image {
                                url
                            }
                        }
                    }
                `
            })
            .then((response) =&gt; {
                resolve(response.data.allProducts)
            })
        })
    },
    getProductById: (id) =&gt; {
        return new Promise((resolve, reject) =&gt; {
            client.query({
                query: gql`
                    query {
                        Product(id: &quot;${id}&quot;) {
                            name,
                            id,
                            image {
                                url
                            },
                            description,
                            price,
                            sku
                        }
                    }
                `
            })
            .then((response) =&gt; {
                resolve(response.data.Product)
            })
        })
    }
}

</code></pre>

<h3 id="toc_8">Creating the store with Snipcart</h3>

<p>So we now have a way to fetch our data. We can retrieve a list of products and a product by its id. Should be enough for our humble tutorial.</p>

<p>Let&#39;s start by listing all our products. Open the router file <code>products.js</code>.</p>

<pre><code>// /app/routers/products.js

const express = require(&#39;express&#39;)
const router = express.Router()
const productsService = require (&#39;./../services/products&#39;)

router.get(&#39;/&#39;, (req, res) =&gt; {
    productsService.getAllProducts()
        .then(function (data) {
            res.render(&#39;products/index&#39;, {
                products: data
            })
        })
})

module.exports = router

</code></pre>

<p>We fetch the products from the GraphQL API, then render a view that we&#39;ll need to create.</p>

<p>Let&#39;s start with the views we need. We&#39;ll start by putting together our base layout. Place a file named <code>layout.pug</code> in <code>/app/views</code> directory.</p>

<pre><code>// /app/views/layout.pug

html
    head
        if title
            title #{ title }
        else
            title Awesome shop powered by GraphCMS and Snipcart

        block styles
            link(href=&#39;https://cdnjs.cloudflare.com/ajax/libs/bulma/0.4.2/css/bulma.min.css&#39;, rel=&#39;stylesheet&#39;, type=&quot;text/css&quot;)
            link(href=&quot;https://cdn.snipcart.com/themes/2.0/base/snipcart.min.css&quot;, type=&quot;text/css&quot;, rel=&quot;stylesheet&quot;)
            link(href=&#39;https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css&#39;, type=&#39;text/css&#39;, rel=&#39;stylesheet&#39;)

        block scripts
            script(src=&quot;https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js&quot;)
            script(src=&quot;https://cdn.snipcart.com/scripts/2.0/snipcart.js&quot;, id=&quot;snipcart&quot;, data-api-key=snipcartApiKey)

    body
        .container
            nav.nav.has-shadow
                .nav-left
                    a(href=&#39;/&#39;).nav-item.is-active.is-tab Spinners

                .nav-right.nav-menu
                    a.nav-item.is-tab.snipcart-summary.snipcart-checkout
                        i.fa.fa-shopping-cart &amp;nbsp;
                        | View cart (
                        span.snipcart-total-items 0
                        | )
        block content

</code></pre>

<p>You will notice that I added some files in there already. First, I included <a href="http://bulma.io/">Bulma</a> to make a decent looking application quickly, FontAwesome for the icons, then jQuery and <a href="https://app.snipcart.com/register">Snipcart</a>&#39;s required files.</p>

<p>I also added a nav bar with the cart content summary in it.</p>

<p>Now that we have a layout, we&#39;ll generate the view that will list the products.</p>

<p>Insert a new file named <code>index.pug</code> in <code>/app/views/products</code> folder.</p>

<pre><code>// /app/views/products/index.pug

extends ../layout.pug
include ../_mixins/snipcart.pug

block content
    .section
        .container
            .heading
                h1.title Our spinners

    .section
        .container
            .columns.is-multiline
                each p in products
                    .column.is-half
                        article.media
                            figure.media-left
                                p.image.is-64x64
                                    img(src=p.image.url)
                            .media-content
                                .content
                                    p
                                        strong #{ p.name }
                                        small  #{ formatMoney(p.price) }
                                        br
                                        | !{ p.description }
                                nav.level
                                    .level-left
                                        +snipcart_button(p).level-item(title=&#39;Add to cart&#39;)
                                            span.icon.is-small
                                                i.fa.fa-cart-plus
                                        a(href=`/products/${p.id}`, title=&#39;View details&#39;).level-item
                                            span.icon.is-small
                                                i.fa.fa-info

</code></pre>

<p>This template will render each product, with its details and two buttons: one to get to the product details and another one to add it to the cart.</p>

<p>You will notice that I used some methods to display things such as <code>formatMoney</code> and a <code>mixin</code> named <code>snipcart_button</code>.</p>

<p>Here&#39;s the code for the mixin:</p>

<pre><code>// /app/views/_mixins/snipcart.pug

mixin snipcart_button(product)
    a(href=&#39;#&#39;).snipcart-add-item&amp;attributes(attributes)(
        data-item-name=product.name
        data-item-id=product.sku
        data-item-price=product.price
        data-item-image=product.image.url
        data-item-url=fullUrl(`/products/${product.id}/json`)
    )
        block

</code></pre>

<p>We&#39;ll see later what&#39;s up with the <code>products/${product.id}/json</code> URL.</p>

<p>The <code>formatMoney</code> will be added to the <code>locals</code>. Open the <code>server.js</code> file and modify it:</p>

<pre><code>// /server.js

const express = require(&#39;express&#39;)
const app = express()
const products = require(&#39;./app/routers/products&#39;)
const path = require(&#39;path&#39;)
const config = require(&#39;./config.json&#39;)

// We need these two packages for display purposes
const numeral = require(&#39;numeral&#39;)
const url = require(&#39;url&#39;)

// We add the methods and properties we need to the response locals.

app.use((req, res, next) =&gt; {
    res.locals = {
        snipcartApiKey: config.snipcartApiKey,
        formatMoney: (number) =&gt; {
            return numeral(number).format(&#39;0.00$&#39;)
        },
        fullUrl: (path) =&gt; {
            return url.format({
                protocol: req.protocol,
                host: req.get(&#39;host&#39;),
                pathname: path
            })
        }
    }
    next()
})

app.use(&#39;/&#39;, products)

app.use((req, res, next) =&gt; {
    res.status(404)
});

app.set(&#39;view engine&#39;, &#39;pug&#39;)
app.set(&#39;views&#39;, path.join(__dirname, &#39;/app/views&#39;))

app.listen(3000, function() {
    console.log(&#39;Listening on port 3000.&#39;);
})

</code></pre>

<p>We&#39;ll then have access to the Snipcart API key and two helper methods in our templates.</p>

<p>If you type: <code>node server.js</code> in your command prompt you should see something like:</p>

<p><img src="media/15244093031262/15244108647779.png" alt="store"/></p>

<p>Pretty neat! Remember when I said we&#39;d come back to the <code>/json</code> route? Now&#39;s the time. One feature we offer that isn&#39;t used enough, in my opinion, is our <a href="https://docs.snipcart.com/configuration/json-crawler">JSON crawler</a>. It&#39;s very useful when you have access to an API or server-side language like we have here.</p>

<p>So we&#39;ll generate a new route that will return the product details in a JSON format that Snipcart can understand. Open <code>products.js</code> router file and add this route handler:</p>

<pre><code>// /app/routers/products.js

router.get(&#39;/products/:id/json&#39;, (req, res, next) =&gt; {
    res.setHeader(&#39;Content-Type&#39;, &#39;application/json&#39;)
    productsService.getProductById(req.params.id)
        .then((product) =&gt; {
            if (!product) {
                next()
            }

            return res.send({
                id: product.sku,
                price: product.price
            })
        })
})

</code></pre>

<p>Whenever we&#39;ll hit this route our app will return a <code>json</code> object that our crawler will understand.</p>

<p>In this file, we are also going to add the route to show the single product details template.</p>

<pre><code>// /app/routers/products.js

router.get(&#39;/products/:id&#39;, (req, res) =&gt; {
    productsService.getProductById(req.params.id)
        .then((product) =&gt; {
            return res.render(&#39;products/details&#39;, {
                product: product
            })
        })
})

</code></pre>

<p>As we did for the products listing, we&#39;ll need to create the <code>products/details.pug</code> view.</p>

<pre><code>// /app/views/products/details.pug

extends ../layout.pug
include ../_mixins/snipcart.pug

block content
    .section
        .container
            .columns
                .card.column.is-half.is-offset-one-quarter
                    .card-image
                        figure.image.is-128x128
                            img(src=product.image.url)
                    .card-content
                        p.title.is-4 #{ product.name }
                            small  #{ formatMoney(product.price) }
                        p #{ product.description }

                    .card-content
                        +snipcart_button(product)
                            span.icon.is-large
                                i.fa.fa-cart-plus                 

</code></pre>

<p>We&#39;ll be using the same <code>mixin</code> that we used earlier to render the buy button.</p>

<h2 id="toc_9">GraphQL &amp; Node.js Express live demo</h2>

<p>You can now browse our demo website, view product details and add them to the cart.</p>

<blockquote>
<p><a href="https://github.com/snipcart/snipcart-graphcms-nodejs">See GitHub code repo</a></p>

<p><a href="https://snipcart-graphcms-nodejs.herokuapp.com/">See live demo</a></p>
</blockquote>

<p>Hope you find the fidget spinner you&#39;re looking for in there!</p>

<h3 id="toc_10">Closing thoughts</h3>

<p>GraphCMS makes it effortless to create easily consumable GraphQL API. The whole demo took me about 2 hours to write, including the learning curve for Apollo and querying a GraphQL API. I hope this will help and inspire you to try these tools! I&#39;m pretty sure that, as developers, we&#39;ll all have to work with this new query language in the near future so it&#39;s a good thing to start learning about it right now.</p>

<p><a href="https://twitter.com/home?status=As%20for%20Express%2C%20it&#x27;s%20very%20easy%20to%20get%20started%20with.%20http%3A%2F%2Fbit.ly%2F2ire4oM%20via%20%40snipcart%20%23nodejs">As for Express, it&#39;s very easy to get started with.</a> Only a few lines of code and you have a web server running that can handle HTTP requests.</p>

<p>If you feel inspired you can visit the <a href="https://github.com/chentsulin/awesome-graphql">GraphQL Awesome list</a> to see all the current possibilities of GraphQL. You can also follow the <a href="https://graphqlweekly.com/">GraphQL Newsletter</a> to stay in the loop!</p>

<hr/>

<p><u>If you found this post valuable, please take a second to <a href="https://twitter.com/home?status=GraphQL%20CMS%20Tutorial%3A%20E-Commerce%20with%20GraphCMS,%20Node.js%20and%20Apollo%20http%3A//bit.ly/2ire4oM%20%40graphcms%20%23graphql%20%23ecommerce">share it on twitter</a>. Found something we missed? Want to discuss your experience with GraphQL, GraphCMS, Node.js or Apollo? Comments are all yours!</u></p>

                        
                      </div>
                  </div>
                </a>
                <div class="read-more clearfix">
                  <div class="more-left left">
                  
                    <span class="date">2018/4/22</span>
                    <span>posted in&nbsp;</span> 
          				  
          					    <span class="posted-in"><a href='E-Commerce.html'>E-Commerce</a></span>
          				   
                  </div>
                  <div class="more-right right">
                  <span class="comments">
                      

                       
                  </span>
                  </div>
                </div>
              </div><!-- article -->
        
              


			<div class="row">
			  <div class="large-6 columns">
			  <p class="text-left" style="padding-top:25px;">
			   
			  </p>
			  </div>
			  <div class="large-6 columns">
			<p class="text-right" style="padding-top:25px;">
			
			</p>
			  </div>
			</div>
		</div>
	</div><!-- large 8 -->

 <div class="large-4 medium-4 columns">
  <div class="hide-for-small">
    <div id="sidebar" class="sidebar">
          <div id="site-info" class="site-info">
            
                <div class="site-a-logo"><img src="http://panlw.github.io/assets/img/logo.png" /></div>
            
                <h1>Junkman</h1>
                <div class="site-des">“拾荒者”一词来自凯文・凯利的《失控》中关于机器学习的故事（“收集癖好机”如何完成他的收集工作）。</div>
                <div class="social">









<a target="_blank" class="github" target="_blank" href="https://github.com/panlw/" title="GitHub">GitHub</a>

  <a target="_blank" class="rss" href="atom.xml" title="RSS">RSS</a>
                
              	 </div>
          	</div>

             

              <div id="site-categories" class="side-item ">
                <div class="side-header">
                  <h2>Categories</h2>
                </div>
                <div class="side-content">

      	<p class="cat-list">
        
            <a href="Infra.html"><strong>Infra</strong></a>
        
            <a href="Coding.html"><strong>Coding</strong></a>
        
            <a href="Solution.html"><strong>Solution</strong></a>
        
            <a href="Archtect.html"><strong>Archtect</strong></a>
         
        </p>


                </div>
              </div>

              <div id="site-categories" class="side-item">
                <div class="side-header">
                  <h2>Recent Posts</h2>
                </div>
                <div class="side-content">
                <ul class="posts-list">
	      
		      
			      <li class="post">
			        <a href="15248848757950.html">Learn to visualize data with this free D3.js course</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="15248846042998.html">Modularizing your GraphQL schema code</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="15248840485977.html">The Basics of Web Workers - HTML5 Rocks</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="15248829536577.html">A tale of Webpack 4 and how to finally configure it in the right way</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="15248824810738.html">理解JWT的使用场景和优劣</a>
			      </li>
		     
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		   
		  		</ul>
                </div>
              </div>
        </div><!-- sidebar -->
      </div><!-- hide for small -->
</div><!-- large 4 -->

</div><!-- row -->

 <div class="page-bottom clearfix">
  <div class="row">
   <p class="copyright">Copyright &copy; 2015
Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a>,&nbsp; 
Theme used <a target="_blank" href="http://github.com">GitHub CSS</a>.</p>
  </div>
</div>

        </section>
      </div>
    </div>

  
    

    <script src="asset/js/foundation.min.js"></script>
    <script>
      $(document).foundation();
      function fixSidebarHeight(){
        var w1 = $('.markdown-body').height();
          var w2 = $('#sidebar').height();
          if (w1 > w2) { $('#sidebar').height(w1); };
      }
      $(function(){
        fixSidebarHeight();
      })
      $(window).load(function(){
          fixSidebarHeight();
      });
     
    </script>

    <script src="asset/chart/all-min.js"></script><script type="text/javascript">$(function(){    var mwebii=0;    var mwebChartEleId = 'mweb-chart-ele-';    $('pre>code').each(function(){        mwebii++;        var eleiid = mwebChartEleId+mwebii;        if($(this).hasClass('language-sequence')){            var ele = $(this).addClass('nohighlight').parent();            $('<div id="'+eleiid+'"></div>').insertAfter(ele);            ele.hide();            var diagram = Diagram.parse($(this).text());            diagram.drawSVG(eleiid,{theme: 'simple'});        }else if($(this).hasClass('language-flow')){            var ele = $(this).addClass('nohighlight').parent();            $('<div id="'+eleiid+'"></div>').insertAfter(ele);            ele.hide();            var diagram = flowchart.parse($(this).text());            diagram.drawSVG(eleiid);        }    });});</script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({TeX: { equationNumbers: { autoNumber: "AMS" } }});</script>


  </body>
</html>
